---
title: "OAuth 2.0 認可コードグラント + PKCE をシーケンス図で理解する"
emoji: "💪"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["oauth2", "pkce"]
published: false
---

## はじめに

OAuth 2.0 のフローをシーケンス図で説明したものはこれまでに何度か見ましたが、

- PKCE (Proof Key for Code Exchange) も含めた一連の流れを整理したかった
- クライアントや認可サーバーでどういったパラメータを元に何を検証しているのかも一連のフローとして理解したかった

というモチベーションがあり、自分でシーケンス図を書いてみた、という趣旨になります。

## フローの説明

- クライアント：web アプリ https://client.example.com
- 認可サーバー：
  - 認可エンドポイント https://server.example.com/authorize
  - アクセストークンエンドポイント： https://server.example.com/token

### 前半: 認可コードリクエスト
#### 1. フロー開始〜 3. 認可リクエスト

クライアントはリダイレクトを利用して、リソースオーナーを認可エンドポイントに誘導します。  
リクエストは以下のような形です。

```
GET /authorize
  ?response_type=code
  &client_id=<client_id>
  &redirect_uri=https://client.example.com/callback
  &scope=read
  &state=xyz
```

パラメータのうち、

- `response_type`: 必須(REQUIRED)。値は必ず `code` にしなければならない(MUST)
- `client_id`: 必須(REQUIRED)
- `redirect_uri`: 任意(OPTIONAL)
- `scope`: 任意(OPTIONAL)
- `state` 推奨(RECOMMENDED)

### 4. `client_id` の検証, 5. `scope` の検証

認可エンドポイントへのリクエストを受け取った認可サーバー側では、はじめに送られてきたパラメータが正しいか検証します。  
具体的には、 `state` を除く各種パラメータについて

- `response_type`: 値が `code` か
- `client_id`: 登録済みのクライアントに一致するものがあるか
- `redirect_uri`: 登録済みの内容と一致するか
- `scope`: 登録済みの内容と一致するか

であることを検証します。

`scope` は扱いが微妙で、[RFC 6749 3.3. アクセストークンのスコープ](
https://openid-foundation-japan.github.io/rfc6749.ja.html#scope) によれば

> 認可サーバーは, 認可サーバーのポリシーまたはリソースオーナーの指示に基づいて, クライアントに要求されたスコープの一部もしくはすべてを無視してもよい (MAY). 発行されたアクセストークンのスコープがクライアントから要求されたものと異なる場合, 認可サーバーは実際に許可されたスコープをクライアントに通知するため, scope レスポンスパラメーターを含めなくてはならない (MUST).
> 
> 認可リクエスト時にクライアントがスコープパラメーターを省略した場合, 認可サーバーは事前に定義されたデフォルト値が指定されたものとするか, 無効なスコープを意味しているものとしてリクエスト失敗とするかのどちらかを処理しなければならない (MUST). 認可サーバーはスコープ要件と (もし定義されていれば) デフォルト値をドキュメント化するべきである (SHOULD).

とあるので、

- `scope` パラメータが省略されたときにするか
- `scope` パラメータが登録済みの内容と一致しなかったり、許可された文字列以外が渡されたときにどうするか

といった場合の処理は各認可サーバーの実装依存になるかと思います。

### ログイン & 認可
認可サーバーはリソースオーナーにログインを促し、クライアントへ各種リソースへの認可を行うかどうか確認します。  
一般的にはユーザーが未ログインであればログイン画面を表示してユーザー名・パスワードによる認証を行った後、「◯◯（クライアント）へ以下のリソースへのアクセスを許可しますか？」という画面を表示することで許可/拒否を尋ねる。

[RFC 6749 3.1. 認可エンドポイント](https://openid-foundation-japan.github.io/rfc6749.ja.html#anchor17) には

> 認可サーバーが用いるリソースオーナーの認証方法 (ユーザー名とパスワードによるログイン, セッションクッキー) については, 本仕様の定めるところではない.

と明記されています。
発行した認可コードは

### 認可コード発行
リソースオーナーの許可が得られた後、認可サーバーは認可コードを発行します。
発行した認可コードはこの後のアクセストークンリクエストの際にリクエストパラメータと突き合わせるため、 `client_id` とひもづけて保存しておきます。

[RFC 6749 4.1.2. 認可レスポンス](https://openid-foundation-japan.github.io/rfc6749.ja.html#code-authz-resp) には

> 漏洩のリスクを軽減するため, 認可コードは発行されてから短期間で無効にしなければならない (MUST). 認可コードの有効期限は最大でも10分を推奨する (RECOMMENDED). 

##### `scope` aaaaaaaa

### 認可レスポンス

### 後半
## 参考リンク

